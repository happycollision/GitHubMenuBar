name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0

jobs:
  build-and-release:
    runs-on: macos-latest

    permissions:
      contents: write  # Required to create releases and upload assets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build release
        run: |
          chmod +x scripts/build_release.sh
          ./scripts/build_release.sh

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          TAG_NAME="v${VERSION}"

          # Determine if this is a prerelease based on version string
          if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi
          echo "prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT

          # Extract author's note from template
          AUTHOR_NOTE=$(sed -n '/^> A note from/,/^> But this toolbar app/p' .github/RELEASE_NOTES_TEMPLATE.md)

          # Extract changelog for this version from CHANGELOG.md (excluding Internal section)
          CHANGELOG_ENTRY=$(awk -v version="$VERSION" '
            /^## \['"$VERSION"'\]/ { found=1; next }
            found && /^## \[/ { exit }
            found && /^### Internal/ { skip=1; next }
            found && /^### / { skip=0 }
            found && !skip && NF > 0 { print }
          ' CHANGELOG.md)

          # Build release notes
          {
            echo "notes<<EOF"
            echo "$AUTHOR_NOTE"
            echo ""
            echo "---"
            echo ""
            if [ -n "$CHANGELOG_ENTRY" ]; then
              echo "## What's New in v${VERSION}"
              echo ""
              echo "$CHANGELOG_ENTRY"
              echo ""
              echo "---"
              echo ""
              echo "ðŸ“‹ [View full CHANGELOG.md at this release](https://github.com/${{ github.repository }}/blob/${TAG_NAME}/CHANGELOG.md)"
            else
              echo "## What's Changed"
              echo ""
              echo "ðŸ“‹ [View CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${TAG_NAME}/CHANGELOG.md) for details."
            fi
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: GitHubMenuBar v${{ steps.get_version.outputs.version }}
          body: |
            ${{ steps.release_notes.outputs.notes }}

            ## Installation

            ### Quick Install (Recommended)

            **YOLO mode - full auto-install:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash -s -- --yolo
            ```

            This will:
            - Download and extract the latest release
            - Remove quarantine attributes (unsigned app handling)
            - Move to `/Applications` automatically
            - Check for GitHub CLI and guide setup if needed

            **Conservative mode - you handle the final steps:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
            ```

            This downloads and extracts only. You'll manually move to `/Applications` and handle first launch.

            **Install specific version:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash -s -- --version v${{ steps.get_version.outputs.version }} --yolo
            ```

            ### Manual Installation

            1. Download `GitHubMenuBar.zip` below
            2. Extract the ZIP file
            3. Move `GitHubMenuBar.app` to your Applications folder
            4. **First launch**: Right-click the app and select "Open" (required for unsigned apps)

            Or bypass Gatekeeper with:
            ```bash
            xattr -cr /Applications/GitHubMenuBar.app
            ```

            ### Requirements
            - macOS 13.0 (Ventura) or later
            - GitHub CLI (`gh`) installed and authenticated
              ```bash
              brew install gh
              gh auth login
              ```
          files: |
            dist/GitHubMenuBar.zip
          draft: false
          prerelease: ${{ steps.release_notes.outputs.prerelease }}
          make_latest: ${{ steps.release_notes.outputs.prerelease == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
